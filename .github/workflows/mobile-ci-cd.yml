name: mobile-ci-cd

on:
  pull_request:
    branches: [ "**" ]
  push:
    branches: [ "develop" ]
    tags:
      - "ios-v*"
      - "android-v*"

jobs:
  ios:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.2
          bundler-cache: true
      - uses: actions/cache@v4
        with:
          path: Pods
          key: pods-${{ runner.os }}-${{ hashFiles('**/Podfile.lock') }}
      - name: Provide ASC API Key
        run: echo "${APP_STORE_CONNECT_API_KEY}" > ./asc_api_key.json
        env:
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
      - run: bundle install
      - run: bundle exec fastlane ios setup
      - run: bundle exec fastlane ios verify
      - run: bundle exec fastlane ios test
      - id: decide
        run: |
          if [[ "${GITHUB_REF}" == refs/heads/develop ]]; then echo "lane=beta" >> $GITHUB_OUTPUT
          elif [[ "${GITHUB_REF}" == refs/tags/ios-v* ]]; then echo "lane=release" >> $GITHUB_OUTPUT
          else echo "lane=none" >> $GITHUB_OUTPUT; fi
      - if: steps.decide.outputs.lane != 'none'
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          MATCH_KEYCHAIN_PASSWORD: ${{ secrets.MATCH_KEYCHAIN_PASSWORD }}
        run: bundle exec fastlane ios ${{ steps.decide.outputs.lane }}

  android:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle
      - name: Decode keystore
        run: |
          mkdir -p app
          echo "$KEYSTORE_BASE64" | base64 -d > app/upload.keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
      - run: chmod +x ./gradlew
      - run: ./gradlew --no-daemon clean
      - run: ./gradlew --no-daemon lint
      - run: ./gradlew --no-daemon testDebug
      - id: decide
        run: |
          if [[ "${GITHUB_REF}" == refs/heads/develop ]]; then echo "lane=beta" >> $GITHUB_OUTPUT
          elif [[ "${GITHUB_REF}" == refs/tags/android-v* ]]; then echo "lane=release" >> $GITHUB_OUTPUT
          else echo "lane=none" >> $GITHUB_OUTPUT; fi
      - if: steps.decide.outputs.lane != 'none'
        env:
          PLAY_JSON_KEY: ${{ secrets.PLAY_JSON_KEY }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_ALIAS_PASSWORD: ${{ secrets.KEY_ALIAS_PASSWORD }}
        run: |
          bundle install
          bundle exec fastlane android ${{ steps.decide.outputs.lane }}
